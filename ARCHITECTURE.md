# SpendWise - Architecture

## System Architecture Diagram

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    SPENDWISE SYSTEM                                      │
└─────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                     EMAIL SOURCES                                        │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐              │
│  │  ICICI Bank │    │  HDFC Bank  │    │  SBI Bank   │    │   Others    │              │
│  │   Emails    │    │   Emails    │    │   Emails    │    │   Emails    │              │
│  └──────┬──────┘    └──────┬──────┘    └──────┬──────┘    └──────┬──────┘              │
│         │                  │                  │                  │                      │
│         └──────────────────┴────────┬─────────┴──────────────────┘                      │
│                                     │                                                    │
│                                     ▼                                                    │
│                          ┌─────────────────────┐                                        │
│                          │    Gmail / IMAP     │                                        │
│                          │      Mailbox        │                                        │
│                          └──────────┬──────────┘                                        │
└─────────────────────────────────────┼───────────────────────────────────────────────────┘
                                      │
                                      │ IMAP (SSL/993)
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              BACKEND SERVER (Python)                                     │
│                                                                                          │
│  ┌────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                           FastAPI Application (Port 8001)                          │ │
│  │                                                                                    │ │
│  │   ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │ │
│  │   │   /accounts  │  │/transactions │  │ /categories  │  │   /devices   │          │ │
│  │   │     API      │  │     API      │  │     API      │  │     API      │          │ │
│  │   │              │  │              │  │              │  │              │          │ │
│  │   │ • GET/POST   │  │ • GET/POST   │  │ • GET/POST   │  │ • POST       │          │ │
│  │   │ • PUT/DELETE │  │ • PUT/DELETE │  │ • Mappings   │  │ • APNs Reg   │          │ │
│  │   │ • Sync       │  │ • CSV Export │  │ • Sync       │  │              │          │ │
│  │   └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘          │ │
│  │          │                 │                 │                 │                   │ │
│  │          └─────────────────┴────────┬────────┴─────────────────┘                   │ │
│  │                                     │                                              │ │
│  │                                     ▼                                              │ │
│  │   ┌─────────────────────────────────────────────────────────────────────────────┐ │ │
│  │   │                         Pydantic Schemas (DTOs)                              │ │ │
│  │   │  AccountCreate/Response │ TransactionCreate/Response │ CategoryResponse     │ │ │
│  │   └─────────────────────────────────────────────────────────────────────────────┘ │ │
│  └────────────────────────────────────────────────────────────────────────────────────┘ │
│                                          │                                              │
│                                          ▼                                              │
│  ┌────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                              SQLAlchemy ORM                                        │ │
│  │                                                                                    │ │
│  │   ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐ │ │
│  │   │  Account   │  │Transaction │  │  Category  │  │Subcategory │  │   Device   │ │ │
│  │   │   Model    │  │   Model    │  │   Model    │  │   Model    │  │   Model    │ │ │
│  │   └────────────┘  └────────────┘  └────────────┘  └────────────┘  └────────────┘ │ │
│  │                                                                                    │ │
│  │   ┌────────────┐  ┌────────────┐                                                  │ │
│  │   │  Vendor    │  │ Processed  │                                                  │ │
│  │   │  Mapping   │  │   Email    │                                                  │ │
│  │   └────────────┘  └────────────┘                                                  │ │
│  └────────────────────────────────────────────────────────────────────────────────────┘ │
│                                          │                                              │
│                                          ▼                                              │
│  ┌────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                                                                                    │ │
│  │                          SQLite Database                                           │ │
│  │                       expense_tracker.db                                           │ │
│  │                                                                                    │ │
│  │   ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                │ │
│  │   │  accounts   │ │transactions │ │ categories  │ │   devices   │                │ │
│  │   └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘                │ │
│  │   ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                                │ │
│  │   │subcategories│ │vendor_map   │ │processed_   │                                │ │
│  │   │             │ │   pings     │ │   emails    │                                │ │
│  │   └─────────────┘ └─────────────┘ └─────────────┘                                │ │
│  └────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                          │
│  ┌────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                           EMAIL PARSER SERVICE (Planned)                           │ │
│  │                                                                                    │ │
│  │   ┌──────────────┐    ┌──────────────┐    ┌──────────────┐                        │ │
│  │   │ IMAP Client  │───▶│ Email Matcher│───▶│ Regex Parser │                        │ │
│  │   │ (imapclient) │    │              │    │              │                        │ │
│  │   └──────────────┘    └──────────────┘    └──────┬───────┘                        │ │
│  │                                                  │                                 │ │
│  │                                                  ▼                                 │ │
│  │                                        ┌──────────────┐                           │ │
│  │                                        │  Create Txn  │                           │ │
│  │                                        │  + Send Push │                           │ │
│  │                                        └──────────────┘                           │ │
│  └────────────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────┬───────────────────────────────────────────────┘
                                          │
                                          │ REST API (HTTP/JSON)
                                          │
                                          ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                  iOS APPLICATION                                         │
│                                                                                          │
│  ┌────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                              SwiftUI Views                                         │ │
│  │                                                                                    │ │
│  │   ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐ │ │
│  │   │ Dashboard  │  │Transaction │  │  Parser    │  │  Category  │  │  Settings  │ │ │
│  │   │  (Charts)  │  │  ListView  │  │  ListView  │  │  ListView  │  │    View    │ │ │
│  │   └─────┬──────┘  └─────┬──────┘  └─────┬──────┘  └─────┬──────┘  └─────┬──────┘ │ │
│  │         │               │               │               │               │         │ │
│  │         └───────────────┴───────┬───────┴───────────────┴───────────────┘         │ │
│  │                                 │                                                  │ │
│  │                                 ▼                                                  │ │
│  │                        ┌────────────────┐                                         │ │
│  │                        │   ContentView  │                                         │ │
│  │                        │  (7-Tab View)  │                                         │ │
│  │                        └────────────────┘                                         │ │
│  └────────────────────────────────────────────────────────────────────────────────────┘ │
│                                          │                                              │
│                                          ▼                                              │
│  ┌────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                              Network Layer                                         │ │
│  │                                                                                    │ │
│  │   ┌─────────────────────────────────────────────────────────────────────────────┐ │ │
│  │   │                          APIClient (Singleton)                               │ │ │
│  │   │                                                                              │ │ │
│  │   │  fetchTransactions()  │  fetchAccounts()  │  fetchCategories()              │ │ │
│  │   │  createTransaction()  │  createAccount()  │  syncVendorMappings()           │ │ │
│  │   │  updateTransaction()  │  syncAccounts()   │  exportTransactionsCSV()        │ │ │
│  │   │  deleteTransaction()  │  deleteAccount()  │  healthCheck()                  │ │ │
│  │   └─────────────────────────────────────────────────────────────────────────────┘ │ │
│  └────────────────────────────────────────────────────────────────────────────────────┘ │
│                                          │                                              │
│                                          ▼                                              │
│  ┌────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                              SwiftData Models                                      │ │
│  │                                                                                    │ │
│  │   ┌────────────────────────────────────────────────────────────────────────────┐  │ │
│  │   │                         @Model Transaction                                 │  │ │
│  │   │                                                                            │  │ │
│  │   │  id │ backendId │ ledger │ category │ subcategory │ currency │ amount     │  │ │
│  │   │  account │ recorder │ date │ time │ vendor │ note │ transactionType       │  │ │
│  │   │  status │ confidenceScore │ createdAt │ updatedAt                         │  │ │
│  │   └────────────────────────────────────────────────────────────────────────────┘  │ │
│  │                                                                                    │ │
│  │   ┌──────────────────┐    ┌──────────────────┐                                   │ │
│  │   │  ParserManager   │    │ CategoryManager  │                                   │ │
│  │   │  (UserDefaults)  │    │  (UserDefaults)  │                                   │ │
│  │   └──────────────────┘    └──────────────────┘                                   │ │
│  └────────────────────────────────────────────────────────────────────────────────────┘ │
│                                          │                                              │
│                                          ▼                                              │
│  ┌────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                              Local Storage                                         │ │
│  │                                                                                    │ │
│  │   ┌──────────────────────────────────┐    ┌──────────────────────────────────┐   │ │
│  │   │        SwiftData Store           │    │          UserDefaults            │   │ │
│  │   │      (Transaction.sqlite)        │    │   (Parsers, VendorMappings)      │   │ │
│  │   └──────────────────────────────────┘    └──────────────────────────────────┘   │ │
│  └────────────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────────────┘


                              ┌───────────────────────┐
                              │   Apple Push (APNs)   │
                              │      (Planned)        │
                              └───────────────────────┘
```

---

## Technology Stack

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                   TECH STACK                                             │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                          │
│   ┌─────────────────────────────┐      ┌─────────────────────────────┐                 │
│   │        BACKEND              │      │         iOS APP             │                 │
│   │                             │      │                             │                 │
│   │  ┌───────────────────────┐  │      │  ┌───────────────────────┐  │                 │
│   │  │   Python 3.11+        │  │      │  │   Swift 5.9+          │  │                 │
│   │  └───────────────────────┘  │      │  └───────────────────────┘  │                 │
│   │                             │      │                             │                 │
│   │  ┌───────────────────────┐  │      │  ┌───────────────────────┐  │                 │
│   │  │   FastAPI 0.109       │  │      │  │   SwiftUI             │  │                 │
│   │  │   (Web Framework)     │  │      │  │   (UI Framework)      │  │                 │
│   │  └───────────────────────┘  │      │  └───────────────────────┘  │                 │
│   │                             │      │                             │                 │
│   │  ┌───────────────────────┐  │      │  ┌───────────────────────┐  │                 │
│   │  │   SQLAlchemy 2.0      │  │      │  │   SwiftData           │  │                 │
│   │  │   (ORM)               │  │      │  │   (Persistence)       │  │                 │
│   │  └───────────────────────┘  │      │  └───────────────────────┘  │                 │
│   │                             │      │                             │                 │
│   │  ┌───────────────────────┐  │      │  ┌───────────────────────┐  │                 │
│   │  │   Pydantic 2.6        │  │      │  │   URLSession          │  │                 │
│   │  │   (Validation)        │  │      │  │   (Networking)        │  │                 │
│   │  └───────────────────────┘  │      │  └───────────────────────┘  │                 │
│   │                             │      │                             │                 │
│   │  ┌───────────────────────┐  │      │  ┌───────────────────────┐  │                 │
│   │  │   SQLite              │  │      │  │   UserDefaults        │  │                 │
│   │  │   (Database)          │  │      │  │   (Settings)          │  │                 │
│   │  └───────────────────────┘  │      │  └───────────────────────┘  │                 │
│   │                             │      │                             │                 │
│   │  ┌───────────────────────┐  │      │  ┌───────────────────────┐  │                 │
│   │  │   Uvicorn             │  │      │  │   Codable/JSON        │  │                 │
│   │  │   (ASGI Server)       │  │      │  │   (Serialization)     │  │                 │
│   │  └───────────────────────┘  │      │  └───────────────────────┘  │                 │
│   │                             │      │                             │                 │
│   │  ┌───────────────────────┐  │      │  ┌───────────────────────┐  │                 │
│   │  │   IMAPClient          │  │      │  │   Swift Charts        │  │                 │
│   │  │   (Email)             │  │      │  │   (Analytics)         │  │                 │
│   │  └───────────────────────┘  │      │  └───────────────────────┘  │                 │
│   │                             │      │                             │                 │
│   │                             │      │  ┌───────────────────────┐  │                 │
│   │                             │      │  │   UNNotification      │  │                 │
│   │                             │      │  │   (Local Push)        │  │                 │
│   │                             │      │  └───────────────────────┘  │                 │
│   │                             │      │                             │                 │
│   └─────────────────────────────┘      └─────────────────────────────┘                 │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Data Flow Diagram

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    DATA FLOW                                             │
└─────────────────────────────────────────────────────────────────────────────────────────┘

                                 ┌─────────────────┐
                                 │  TRANSACTION    │
                                 │  ALERT EMAIL    │
                                 └────────┬────────┘
                                          │
                                          ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│ FLOW 1: AUTO PARSING (IMAP - Planned)                                                    │
│                                                                                          │
│   Email ──▶ IMAP Fetch ──▶ Match Sender ──▶ Apply Regex ──▶ Create Transaction          │
│                              Pattern         Parser           │                          │
│                                                               ▼                          │
│                                                        ┌─────────────┐                  │
│                                                        │  Database   │                  │
│                                                        │ Transaction │                  │
│                                                        └─────────────┘                  │
│                                                               │                          │
│                                                               ▼                          │
│                                                        ┌─────────────┐                  │
│                                                        │ Push Notify │                  │
│                                                        │   (APNs)    │                  │
│                                                        └─────────────┘                  │
└─────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│ FLOW 2: MANUAL SYNC (iOS App)                                                            │
│                                                                                          │
│   ┌───────────┐         ┌───────────┐         ┌───────────┐         ┌───────────┐      │
│   │  iOS App  │ ──GET──▶│  FastAPI  │ ──SQL──▶│  SQLite   │ ──JSON─▶│  iOS App  │      │
│   │  Launch   │         │  Server   │         │  Database │         │  Display  │      │
│   └───────────┘         └───────────┘         └───────────┘         └───────────┘      │
│                                                                                          │
│   GET /transactions?days=60  ──▶  Query DB  ──▶  Return JSON Array                      │
└─────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│ FLOW 3: MANUAL ENTRY (iOS App)                                                           │
│                                                                                          │
│   ┌───────────┐         ┌───────────┐         ┌───────────┐         ┌───────────┐      │
│   │   User    │ ──Add──▶│ SwiftData │ ──POST─▶│  FastAPI  │ ──Save─▶│  SQLite   │      │
│   │   Input   │         │   Local   │         │  Server   │         │  Database │      │
│   └───────────┘         └───────────┘         └───────────┘         └───────────┘      │
│                                                                                          │
│   Form Input  ──▶  Save Local  ──▶  POST /transactions  ──▶  Update backendId          │
└─────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│ FLOW 4: CSV EXPORT                                                                       │
│                                                                                          │
│   ┌───────────┐         ┌───────────┐         ┌───────────┐         ┌───────────┐      │
│   │   User    │ ─Export─▶│  FastAPI  │ ─Query─▶│  SQLite   │ ─CSV───▶│   File    │      │
│   │  Request  │         │  Server   │         │  Database │         │  Download │      │
│   └───────────┘         └───────────┘         └───────────┘         └───────────┘      │
│                                                                                          │
│   GET /transactions/export/csv  ──▶  Generate CSV  ──▶  Stream Response                 │
│                                                                                          │
│   CSV Format: Ledger,Category,Subcategory,Currency,Price,Account,Recorder,              │
│               Date,Time,Note,Transaction                                                 │
└─────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│ FLOW 5: DASHBOARD ANALYTICS (iOS App)                                                   │
│                                                                                          │
│   ┌───────────┐         ┌───────────┐         ┌───────────┐         ┌───────────┐      │
│   │ Dashboard │ ─Filter─▶│ SwiftData │ ─Compute─▶│  Charts   │ ─Render─▶│   UI      │      │
│   │   View    │  Period  │   Query   │  Metrics │  Library  │  Graphs │  Display  │      │
│   └───────────┘         └───────────┘         └───────────┘         └───────────┘      │
│                                                                                          │
│   Analytics Pipeline:                                                                    │
│                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │  Transactions ──▶ Filter (Expense + Period) ──▶ Aggregate by:                   │  │
│   │                                                                                  │  │
│   │    ┌──────────────┐   ┌──────────────┐   ┌──────────────┐   ┌──────────────┐   │  │
│   │    │  Category    │   │    Date      │   │   Merchant   │   │   Summary    │   │  │
│   │    │  Pie Chart   │   │  Line Chart  │   │   Rankings   │   │    Cards     │   │  │
│   │    │  (SectorMark)│   │  (AreaMark)  │   │  (Top 5)     │   │  (4 KPIs)    │   │  │
│   │    └──────────────┘   └──────────────┘   └──────────────┘   └──────────────┘   │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                          │
│   Time Periods: Week (7d) │ Month (30d) │ Quarter (90d) │ Year (365d)                  │
└─────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│ FLOW 6: LOCAL NOTIFICATIONS (Background Polling)                                        │
│                                                                                          │
│   ┌───────────┐         ┌───────────┐         ┌───────────┐         ┌───────────┐      │
│   │  Timer    │ ─Poll──▶│  Backend  │ ─Check──▶│  Compare  │ ─Alert──▶│  System   │      │
│   │  (30s/15m)│  API    │   Server  │  IDs    │  New Txns │  User   │  Notif    │      │
│   └───────────┘         └───────────┘         └───────────┘         └───────────┘      │
│                                                                                          │
│   NotificationService: isPollingEnabled ─▶ Timer ─▶ fetchTransactions() ─▶              │
│                         Compare with knownIds ─▶ UNMutableNotificationContent           │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Database Schema

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                  DATABASE SCHEMA                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────┐       ┌─────────────────────────┐
│       accounts          │       │     transactions        │
├─────────────────────────┤       ├─────────────────────────┤
│ id (PK, UUID)           │──┐    │ id (PK, INT)            │
│ name                    │  │    │ source_email_id         │
│ card_last_four          │  │    │ idempotency_key         │
│ sender_email            │  │    │ ledger                  │
│ sender_name             │  │    │ category_name           │
│ subject_pattern         │  │    │ subcategory             │
│ amount_regex            │  │    │ currency                │
│ date_regex              │  │    │ parsed_amount           │
│ merchant_regex          │  │    │ account_name            │
│ account_regex           │  └───▶│ account_id (FK)         │
│ time_regex              │       │ recorder                │
│ sample_email_body       │       │ parsed_date             │
│ is_active               │       │ parsed_time             │
│ currency_default        │       │ parsed_vendor           │
│ default_transaction_type│       │ notes                   │
│ created_at              │       │ transaction_type        │
│ updated_at              │       │ status                  │
└─────────────────────────┘       │ confidence_score        │
                                  │ created_at              │
                                  │ updated_at              │
                                  └─────────────────────────┘

┌─────────────────────────┐       ┌─────────────────────────┐
│      categories         │       │     subcategories       │
├─────────────────────────┤       ├─────────────────────────┤
│ id (PK, INT)            │◀──┐   │ id (PK, INT)            │
│ name                    │   │   │ category_id (FK)        │──┘
│ icon                    │   │   │ name                    │
│ color                   │   │   │ icon                    │
│ is_system               │   │   │ created_at              │
│ created_at              │   │   │ updated_at              │
│ updated_at              │   │   └─────────────────────────┘
└─────────────────────────┘   │
         │                    │   ┌─────────────────────────┐
         │                    │   │    vendor_mappings      │
         │                    │   ├─────────────────────────┤
         └────────────────────┼──▶│ id (PK, INT)            │
                              │   │ vendor_keyword          │
                              └──▶│ category_id (FK)        │
                                  │ subcategory_id (FK)     │
                                  │ is_user_defined         │
                                  │ match_count             │
                                  │ created_at              │
                                  │ updated_at              │
                                  └─────────────────────────┘

┌─────────────────────────┐       ┌─────────────────────────┐
│    processed_emails     │       │        devices          │
├─────────────────────────┤       ├─────────────────────────┤
│ id (PK, UUID)           │       │ id (PK, UUID)           │
│ message_id              │       │ device_token            │
│ account_id (FK)         │       │ environment             │
│ processed_at            │       │ device_name             │
│ status                  │       │ os_version              │
│ error_message           │       │ is_active               │
└─────────────────────────┘       │ created_at              │
                                  │ updated_at              │
                                  └─────────────────────────┘
```

---

## API Endpoints Map

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                API ENDPOINTS (Port 8001)                                 │
└─────────────────────────────────────────────────────────────────────────────────────────┘

BASE URL: http://127.0.0.1:8001

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│ TRANSACTIONS                                                                             │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                          │
│   GET    /transactions/?days=60      ──▶  List transactions (last N days)               │
│   GET    /transactions/{id}          ──▶  Get single transaction                        │
│   POST   /transactions/              ──▶  Create transaction                            │
│   PUT    /transactions/{id}          ──▶  Update transaction                            │
│   DELETE /transactions/{id}          ──▶  Delete transaction                            │
│   GET    /transactions/export/csv    ──▶  Export as CSV file                            │
│   POST   /transactions/bulk          ──▶  Bulk create transactions                      │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│ ACCOUNTS (Parser Profiles)                                                               │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                          │
│   GET    /accounts/                  ──▶  List all accounts                             │
│   GET    /accounts/{id}              ──▶  Get single account                            │
│   POST   /accounts/                  ──▶  Create account                                │
│   PUT    /accounts/{id}              ──▶  Update account                                │
│   DELETE /accounts/{id}              ──▶  Delete account                                │
│   POST   /accounts/sync              ──▶  Sync accounts from iOS                        │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│ CATEGORIES                                                                               │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                          │
│   GET    /categories/                ──▶  List categories with subcategories            │
│   GET    /categories/{id}            ──▶  Get single category                           │
│   POST   /categories/                ──▶  Create category                               │
│   PUT    /categories/{id}            ──▶  Update category                               │
│   DELETE /categories/{id}            ──▶  Delete category                               │
│   POST   /categories/{id}/subcategories  ──▶  Add subcategory                           │
│   GET    /categories/mappings/       ──▶  List vendor mappings                          │
│   POST   /categories/mappings/       ──▶  Create vendor mapping                         │
│   POST   /categories/mappings/sync   ──▶  Sync mappings from iOS                        │
│   GET    /categories/mappings/export ──▶  Export mappings for iOS                       │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│ DEVICES & HEALTH                                                                         │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                          │
│   POST   /devices/                   ──▶  Register device for push                      │
│   DELETE /devices/{token}            ──▶  Unregister device                             │
│   GET    /                           ──▶  App info                                      │
│   GET    /health                     ──▶  Health check                                  │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## iOS App Structure

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                               iOS APP STRUCTURE                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘

                                ┌─────────────────┐
                                │  App Launch     │
                                │  @main          │
                                └────────┬────────┘
                                         │
                                         ▼
                                ┌─────────────────┐
                                │   ContentView   │
                                │    (TabView)    │
                                └────────┬────────┘
                                         │
            ┌────────────┬───────────────┼───────────────┬────────────┬────────────┐
            │            │               │               │            │            │
            ▼            ▼               ▼               ▼            ▼            ▼
     ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐
     │Transaction│ │  Parser   │ │ Category  │ │  Export   │ │  Import   │ │ Settings  │
     │  ListView │ │ ListView  │ │ ListView  │ │   View    │ │   View    │ │   View    │
     └─────┬─────┘ └─────┬─────┘ └─────┬─────┘ └─────┬─────┘ └─────┬─────┘ └─────┬─────┘
           │             │             │             │             │             │
           ▼             ▼             ▼             ▼             │             ▼
     ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐       │       ┌───────────┐
     │   Edit    │ │   Edit    │ │   Edit    │ │   Share   │       │       │   Sync    │
     │Transaction│ │  Parser   │ │ Category  │ │   Sheet   │       │       │  Options  │
     │   View    │ │   View    │ │   View    │ │   (CSV)   │       │       │           │
     └───────────┘ └───────────┘ └───────────┘ └───────────┘       │       └───────────┘
           │             │             │                           │
           └─────────────┴─────────────┴───────────────────────────┘
                                       │
                                       ▼
                              ┌─────────────────┐
                              │   APIClient     │
                              │   (Singleton)   │
                              │                 │
                              │ • Transactions  │
                              │ • Accounts      │
                              │ • Categories    │
                              │ • Mappings      │
                              │ • CSV Export    │
                              └────────┬────────┘
                                       │
                    ┌──────────────────┼──────────────────┐
                    │                  │                  │
                    ▼                  ▼                  ▼
           ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
           │   SwiftData     │ │  ParserManager  │ │ CategoryManager │
           │   (Persistent)  │ │  (UserDefaults) │ │ (UserDefaults)  │
           │                 │ │                 │ │                 │
           │   Transaction   │ │  ParserProfile  │ │  ActionCategory │
           │   Model         │ │  Array          │ │  Dictionary     │
           └─────────────────┘ └─────────────────┘ └─────────────────┘
```

---

## Planned Architecture Extensions

### Phase 6: Tools & Import Module (PLANNED)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           TOOLS & IMPORT MODULE                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌─────────────────┐          ┌─────────────────┐          ┌─────────────────┐ │
│  │  Paytm Excel    │          │  Import History │          │  CSV Generator  │ │
│  │  Parser         │          │  Tracker        │          │                 │ │
│  │                 │          │                 │          │                 │ │
│  │  • .xlsx read   │   ───▶   │  • filename     │   ───▶   │  • preview      │ │
│  │  • column map   │          │  • file_hash    │          │  • download     │ │
│  │  • validation   │          │  • dedup check  │          │  • confirm      │ │
│  └────────┬────────┘          └────────┬────────┘          └────────┬────────┘ │
│           │                            │                            │          │
│           └────────────────────────────┼────────────────────────────┘          │
│                                        │                                        │
│                                        ▼                                        │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │                         API Endpoints                                     │  │
│  │  POST /tools/import/paytm          - Upload & parse                      │  │
│  │  POST /tools/import/paytm/confirm  - Confirm import                      │  │
│  │  GET  /tools/import/paytm/download - Download CSV                        │  │
│  │  GET  /tools/import/history        - Import history                      │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### Phase 7: User Financial Accounts (PLANNED)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         USER FINANCIAL ACCOUNTS                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  Account Types:                                                                  │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐          │
│  │  Bank    │  │  Credit  │  │  Wallet  │  │   Cash   │  │Investment│          │
│  │ Account  │  │   Card   │  │(Paytm etc│  │          │  │ Account  │          │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘          │
│       │             │             │             │             │                  │
│       └─────────────┴─────────────┼─────────────┴─────────────┘                  │
│                                   │                                              │
│                                   ▼                                              │
│              ┌──────────────────────────────────────────┐                       │
│              │           UserAccount Model               │                       │
│              │                                          │                       │
│              │  • id, name, type                        │                       │
│              │  • institution, account_number_last4     │                       │
│              │  • currency, initial_balance             │                       │
│              │  • is_active, color, icon                │                       │
│              │  • linked_parser_id (FK to Account)      │                       │
│              └──────────────────────────────────────────┘                       │
│                                   │                                              │
│                                   ▼                                              │
│              ┌──────────────────────────────────────────┐                       │
│              │           Transaction Link                │                       │
│              │                                          │                       │
│              │  Transaction.user_account_id ──▶ UserAccount.id                  │
│              │  (Each transaction belongs to an account)│                       │
│              └──────────────────────────────────────────┘                       │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### Phase 8: Transaction Sources (PLANNED)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         TRANSACTION SOURCES                                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │   Email     │  │   Manual    │  │   Import    │  │   SMS       │            │
│  │  (Gmail/    │  │   Entry     │  │  (Paytm     │  │  (iOS       │            │
│  │   IMAP)     │  │   (App)     │  │   Excel)    │  │   Shortcut) │            │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘            │
│         │                │                │                │                    │
│    recorder:        recorder:        recorder:        recorder:                 │
│     "Auto"          "Manual"         "Import"          "SMS"                    │
│         │                │                │                │                    │
│         └────────────────┴────────────────┼────────────────┘                    │
│                                           │                                      │
│                                           ▼                                      │
│                              ┌─────────────────────┐                            │
│                              │     Transaction     │                            │
│                              │    (Backend DB)     │                            │
│                              └─────────────────────┘                            │
│                                                                                  │
│  iOS Shortcut Flow:                                                             │
│  ┌─────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐          │
│  │Bank SMS │ ──▶│iOS Shortcut │ ──▶│API: POST    │ ──▶│Transaction  │          │
│  │received │    │extracts data│    │/shortcuts/  │    │created      │          │
│  │         │    │             │    │transaction  │    │             │          │
│  └─────────┘    └─────────────┘    └─────────────┘    └─────────────┘          │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### Updated iOS Tab Structure (PLANNED)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           iOS TAB STRUCTURE (PLANNED)                            │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  Current (7 tabs):                      Planned (7 tabs):                       │
│  ┌─────────────────────┐                ┌─────────────────────┐                 │
│  │ 1. Dashboard     ✅ │                │ 1. Dashboard     ✅ │                 │
│  │ 2. Transactions  ✅ │                │ 2. Transactions  ✅ │                 │
│  │ 3. Parsers       ✅ │                │ 3. Accounts      🔄 │  ◀── NEW       │
│  │ 4. Categories    ✅ │                │ 4. Parsers       ✅ │                 │
│  │ 5. Export        ✅ │                │ 5. Categories    ✅ │                 │
│  │ 6. Import        ✅ │                │ 6. Tools         🔄 │  ◀── MERGED    │
│  │ 7. Settings      ✅ │                │ 7. Settings      ✅ │                 │
│  └─────────────────────┘                └─────────────────────┘                 │
│                                                                                  │
│  Tools Tab Contents (Import + Export merged):                                   │
│  ┌─────────────────────────────────────────────────────────────┐               │
│  │  IMPORT SECTION:                                             │               │
│  │  • Paytm Import (Excel upload, preview, confirm/download)   │               │
│  │  • Bank Statement Import (Future: HDFC, ICICI, SBI)        │               │
│  │  • Import History (view past imports, prevent duplicates)   │               │
│  │                                                              │               │
│  │  EXPORT SECTION:                                             │               │
│  │  • CSV Export (local file / share)                          │               │
│  │  • Server Export (backend CSV generation)                   │               │
│  └─────────────────────────────────────────────────────────────┘               │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

*Generated: February 17, 2026*
*See ROADMAP.md for implementation details*
